# 执行上下文和执行栈

## 执行上下文

### 定义

JS 代码执行时候的抽象环境，包含当前代码可以获取的变量，函数，作用域链，this 指向等信息

包含三个核心部分：

* 变量对象： 储存变量和函数声明
* 作用域链：包含当前变量对象和所有父级变量对象
* `this` 值：当前执行上下文的 this 指向

### 类型

全局执行上下文：默认的上下文，代码未在函数中运行时候创建
函数执行上下文：每次调用函数时创建，包括函数参数，局部变量，以及作用域链，函数执行结束后销毁
eval 上下文：通过 eval() 执行代码时候创建，不推荐

### 生命周期

创建阶段

- 生成变量
- 建立作用域链
- 确定 `This`指向

执行阶段

- 变量赋值
- 调用函数
- 执行代码

## 执行栈

### 定义和原理

执行栈是一种`LIFO`后进先出的栈结构，用于管理多个执行上下文的创建和销毁。

### 运行流程

- **初始状态**: 全局执行上下文入栈
- **函数调用 ​**​: 每次调用函数时，创建对应的函数执行上下文并压入栈顶，成为当前活动上下文。
- **执行完毕**: 栈顶上下文出栈，控制权交还给下层上下文

### 堆栈溢出

如果递归没有终止条件，执行栈超出限制会抛出错误.如 (`Maximum call stack size exceeded`)

## 关键机制

### 作用域链

查找变量时，引擎从当前 ​​ 变量对象（VO）​​ 或 ​​ 活动对象（AO）开始，沿作用域链逐级向上查找，直至全局对象

### 闭包

闭包是函数和其词法环境的组合。即使外层函数执行完毕，其变量对象仍被内层函数引用而无法销毁，形成私有数据空间。

```TS
function counter() {
  let count = 0;
  return function() { return ++count; };
}
const increment = counter();
increment(); // 1
increment(); // 2
```

### `this`指向

- 全局上下文: `this`指向全局对象 (浏览器指向 window)
- 函数上下文: 默认指向调用者，可通过`call/apply/bind`显示绑定或箭头函数继承外层 `this`

# 总结

- **执行上下文**是代码执行的环境抽象，包含变量，作用域和`this`。
- **执行栈**是管理上下文的容器，通过 LIFO 机制控制代码执行顺序。

