# 性能优化

前端性能优化是个大话题，通常从 加载速度、运行效率、交互流畅度 三个维度来考虑。

## 一 资源加载优化

### 减少请求体积

- 代码压缩 (js, css , html)
- 图片压缩 (webp / avif , 雪碧图, 懒加载)
- 使用字体子集(subset) 而不是整套字体

### 减少请求数量

- Tree-shaking 移除未使用代码
- 按需加载组件 (路由懒加载, 动态import)
- 合并小文件 (图标使用iconFont / svg sprite)

### 网络传输优化

- 使用HTTP/2 http/3 (多路复用)
- 开启Gzip / brotli 压缩
- CDN 静态资源分发,缩短往返延时

## 二 渲染优化 (让首屏更快出现)

### 关键渲染路径优化

- css 放头部,js 放底部 defer / async
- Critical CSS 内联（首屏关键样式直接写到 HTML 里）
- 服务端渲染（SSR）/ 预渲染（Prerender）

### 减少阻塞

- 拆分大JS 包（避免一次性下载 + 执行过久）
- 使用 Web Worker 把耗时计算丢后台线程

## 三 运行时优化 (让交互更流畅)

### 减少重排 和 重绘

- 批量DOM 修改, 用 (DocumentFragment / requestAnimationFrame 包裹)
- 避免频繁读取 layout 属性（如 offsetTop / scrollHeight），必要时缓存

### 动画优化

- 尽量用transform + opacity ,避免触发布局
- 开启GPU 加速 （translateZ(0) trick）
- 使用 requestAnimationFrame 驱动动画，而不是 setInterval

### 事件优化

- 频繁触发的事件（scroll、resize、input）要做节流/防抖
- 使用 Passive Event Listener ({ passive: true }) 提升滚动性能

## 四 内存与资源管理

### 避免内存泄露

- Vue / React 组件卸载时移除事件监听、清理定时器
- 避免全局变量滥用

### 缓存利用

- HTTP 缓存策略 （强缓存 Cache-Control、协商缓存 ETag）
- Service Worker 离线缓存

## 五 构建层面的优化

### Webpack / Vite 优化

- 代码分割
- 按需引入 UI 库
- 依赖预构建（Vite esbuild 预构建）

### 生产环境优化

- 开启 SourceMap 分环境（生产只保留 cheap-source-map 或关闭）
- 去掉 console.log / debugger（babel-plugin-transform-remove-console）

## 六 监控与度量

### 性能指标

- LCP（Largest Contentful Paint）最大内容绘制时间
- FID（First Input Delay）首次输入延迟
- CLS（Cumulative Layout Shift）累计布局偏移

## 如何开启 Gzip / brotli 压缩

Brotli 压缩率更好，但压缩耗时更久 → 适合静态资源预压缩；Gzip 压缩速度快 → 适合动态内容。生产环境里推荐 Brotli + Gzip 双保险。

```nginx
# 开启 Gzip
gzip on;
gzip_types text/plain text/css application/javascript application/json image/svg+xml;
gzip_min_length 1k;
gzip_comp_level 6;

# 开启 Brotli（需要安装 brotli 模块）
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/javascript application/json image/svg+xml;
```

```js
// Gzip
import compression from "compression";
app.use(compression());

// Brotli (Node >= 11.7)
import shrinkRay from "shrink-ray-current"; 
app.use(shrinkRay()); // 同时支持 gzip + brotli
```

前端构建工具（预压缩）

比如 Vite / Webpack，打包时直接生成 .gz 和 .br 文件，服务器只需配置好：

Vite

```sh
npm install vite-plugin-compression -D
```

```js
import viteCompression from 'vite-plugin-compression'

export default {
  plugins: [
    viteCompression({ algorithm: 'brotliCompress' }),
    viteCompression({ algorithm: 'gzip' })
  ]
}
```

Webpack

```sh
npm install compression-webpack-plugin -D
```

```js
const CompressionPlugin = require("compression-webpack-plugin");

module.exports = {
  plugins: [
    new CompressionPlugin({ algorithm: "brotliCompress" }),
    new CompressionPlugin({ algorithm: "gzip" })
  ]
};
```
