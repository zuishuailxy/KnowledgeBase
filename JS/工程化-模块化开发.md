# 模块化开发

## ES Modules vs CommonJS

## 核心差异对比

| 特性 | ES Modules (ESM) | CommonJS (CJS) |
|------|------------------|----------------|
| **语法** | `import/export` | `require()/module.exports` |
| **加载时机** | 编译时（静态） | 运行时（动态） |
| **执行环境** | 浏览器原生支持 | Node.js原生支持 |
| **异步加载** | 天然支持 | 同步加载 |
| **Tree Shaking** | 完美支持 | 困难 |
| **循环依赖** | 更好处理 | 可能出问题 |
| **顶层await** | 支持 | 不支持 |
| **文件扩展名** | `.mjs` 或 `"type": "module"` | `.js` 或 `.cjs` |

## ES Modules 详解

### 1. 基础导出语法

#### 命名导出 (Named Exports)

```javascript
// math.js
export const PI = 3.14159;

export function add(a, b) {
  return a + b;
}

export function multiply(a, b) {
  return a * b;
}

// 批量导出
const subtract = (a, b) => a - b;
const divide = (a, b) => a / b;

export { subtract, divide };

// 重命名导出
const pow = Math.pow;
export { pow as power };
```

#### 默认导出 (Default Export)

```javascript
// calculator.js - 只能有一个默认导出
export default class Calculator {
  add(a, b) { return a + b; }
  subtract(a, b) { return a - b; }
}

// 或者
class Calculator {
  // ...
}
export default Calculator;

// 或者直接导出值
export default function(a, b) {
  return a + b;
}
```

#### 混合导出

```javascript
// utils.js
export const VERSION = '1.0.0';

export function helper() {
  return 'helper function';
}

// 默认导出
export default class MainUtility {
  constructor() {
    this.version = VERSION;
  }
}
```

### 2. 导入语法

#### 命名导入

```javascript
// 基础导入
import { add, multiply } from './math.js';

// 重命名导入
import { add as sum, multiply as times } from './math.js';

// 导入所有命名导出
import * as math from './math.js';
console.log(math.add(2, 3)); // 5
console.log(math.PI); // 3.14159
```

#### 默认导入

```javascript
// 默认导入（名称可以自定义）
import Calculator from './calculator.js';
import Calc from './calculator.js'; // 同样有效

// 混合导入
import Calculator, { VERSION, helper } from './utils.js';
```

#### 动态导入

```javascript
// 运行时动态导入
async function loadMath() {
  const math = await import('./math.js');
  return math.add(2, 3);
}

// 条件导入
if (someCondition) {
  const { heavyFunction } = await import('./heavy-module.js');
  heavyFunction();
}

// 动态模块路径
const moduleName = 'math';
const math = await import(`./modules/${moduleName}.js`);
```

### 3. ES Modules 高级特性

#### 重导出 (Re-exports)

```javascript
// index.js - 聚合模块
export { add, multiply } from './math.js';
export { default as Calculator } from './calculator.js';
export * from './utils.js';

// 重命名重导出
export { 
  add as sum,
  multiply as times 
} from './math.js';

// 重导出默认为命名
export { default as MathUtils } from './math.js';
```

#### 顶层 await

```javascript
// data.js - ES2022特性
const response = await fetch('/api/config');
const config = await response.json();

export default config;

// main.js
import config from './data.js'; // 自动等待异步操作完成
console.log(config);
```

### 特点

- 静态结构：import/export 必须在顶层，不能放在 if / function 中。

- 实时绑定（live binding）：导出值更新，导入方能感知。

- 异步加载，支持 tree-shaking（按需打包）。

## CommonJS 详解

### 1. 基础用法

#### 导出语法

```javascript
// math.js
const PI = 3.14159;

function add(a, b) {
  return a + b;
}

function multiply(a, b) {
  return a * b;
}

// 方式1：逐个导出
exports.PI = PI;
exports.add = add;
exports.multiply = multiply;

// 方式2：批量导出
module.exports = {
  PI,
  add,
  multiply
};

// 方式3：覆盖整个exports
module.exports = add; // 只导出add函数
```

#### 导入语法

```javascript
// 完整导入
const math = require('./math');
console.log(math.add(2, 3));

// 解构导入
const { add, multiply, PI } = require('./math');

// 直接导入（如果模块只导出一个值）
const add = require('./math'); // 如果math.js中 module.exports = add
```

### 2. CommonJS 特点

#### 同步加载

```javascript
// 同步加载，会阻塞后续代码
const fs = require('fs'); // 立即加载
const data = fs.readFileSync('file.txt'); // 同步操作
console.log('这行代码会等待上面的操作完成');
```

#### 运行时解析

```javascript
// 可以在条件语句中require
if (process.env.NODE_ENV === 'development') {
  const debug = require('debug'); // 只在开发环境加载
  debug('Debug mode enabled');
}

// 可以动态构造模块路径
const moduleName = 'lodash';
const _ = require(moduleName);
```

### 特点

- 动态导入：require 可以放在条件、函数里。

- 值拷贝：导出的是值的拷贝（对象/函数是引用）。

- 同步加载。

## 优势对比

### ES Modules

- Tree Shaking - 打包体积更小
- 并行加载 - 浏览器性能更好
- 静态分析 - IDE智能提示更准确
- 标准化 - 浏览器和Node.js统一

### CommonJs

- 动态加载 - 运行时条件导入
- Node.js生态 - 大量现有包
- 简单直接 - 学习成本低
