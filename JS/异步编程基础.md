# äº‹ä»¶å¾ªçŽ¯

å› ä¸ºJS æ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥éœ€è¦äº‹ä»¶å¾ªçŽ¯æ¥è°ƒåº¦åŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ã€‚

## è°ƒç”¨æ ˆ call stack

- js ä»£ç ä»Žä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
- åŒæ­¥ä»£ç ä¼šä¾æ¬¡è¿›å…¥è°ƒç”¨æ ˆå¹¶æ‰§è¡Œ
- å¼‚æ­¥ä»»åŠ¡ ï¼ˆå®šæ—¶å™¨ï¼Œ Promiseï¼Œ äº‹ä»¶ç›‘å¬ï¼‰ä¸ä¼šç›´æŽ¥æ‰§è¡Œï¼Œè€Œæ˜¯äº¤ç»™å®¿ä¸»çŽ¯å¢ƒï¼ˆæµè§ˆå™¨ / Node.jsï¼‰ å¤„ç†ã€‚

## ä»»åŠ¡é˜Ÿåˆ— Task queue

ä»»åŠ¡åˆ†ä¸ºï¼š

- å®ä»»åŠ¡ï¼ˆmacrotaskï¼‰ï¼š
  æ¯æ¬¡äº‹ä»¶å¾ªçŽ¯ä¼šæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ã€‚
  åŒ…å«ï¼š setTimeout, setInterval, setImmediateï¼ˆNode.jsï¼‰, requestAnimationFrame, I/O, äº‹ä»¶å›žè°ƒ, scriptæ•´ä½“ä»£ç 

- å¾®ä»»åŠ¡ ï¼ˆmircotaskï¼‰ï¼š
  åœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåŽï¼Œç«‹å³æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„æ‰€æœ‰å¾®ä»»åŠ¡ã€‚
  åŒ…å«ï¼šPromise.then, process.nextTickï¼ˆNode.jsï¼‰, MutationObserverï¼Œ queueMicrotask

## äº‹ä»¶å¾ªçŽ¯æµç¨‹ åŒæ­¥ä»£ç  â†’ å¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡

1. æ‰§è¡Œå…¨å±€ä»£ç  ï¼ˆç¬¬ä¸€ä¸ªå®ä»»åŠ¡ï¼‰
2. é‡åˆ°å¼‚æ­¥ä»»åŠ¡ -> äº¤ç»™å®¿ä¸»çŽ¯å¢ƒå¤„ç†
3. æ‰§è¡Œå®ŒåŒæ­¥ä»£ç åŽ â†’ æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€æ¬¡æ€§æ¸…ç©ºã€‚
4. è‹¥å¾®ä»»åŠ¡æ¸…ç©ºå®Œæˆ â†’ å†ä»Žå®ä»»åŠ¡é˜Ÿåˆ—å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œæ”¾åˆ°æ‰§è¡Œæ ˆä¸­ã€‚
5. é‡å¤ä»¥ä¸Šæ­¥éª¤ â†’ å½¢æˆ å¾ªçŽ¯ï¼ˆevent loopï¼‰ã€‚

## ç¤ºä¾‹

```js
console.log("start");

setTimeout(() => {
  console.log("timeout");
}, 0);

Promise.resolve().then(() => {
  console.log("promise");
});

console.log("end");

```

ðŸ‘‰ æ‰§è¡Œé¡ºåºï¼š

1. console.log("start") â†’ åŒæ­¥ä»»åŠ¡

2. setTimeout(...) â†’ åŠ å…¥ å®ä»»åŠ¡é˜Ÿåˆ—

3. Promise.then(...) â†’ åŠ å…¥ å¾®ä»»åŠ¡é˜Ÿåˆ—

4. console.log("end") â†’ åŒæ­¥ä»»åŠ¡

5. æ¸…ç©º å¾®ä»»åŠ¡é˜Ÿåˆ— â†’ è¾“å‡º "promise"

6. å–å‡ºå®ä»»åŠ¡ï¼ˆsetTimeoutï¼‰ â†’ è¾“å‡º "timeout"

## æ€»ç»“å£è¯€

- å…ˆæ‰§è¡Œæ ˆ â†’ å¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡

- å¾®ä»»åŠ¡æ°¸è¿œæ¯”å®ä»»åŠ¡å…ˆæ‰§è¡Œ

## setTimeout ã€ setInterval

### setTimeout(fn, delay)

åœ¨æŒ‡å®šçš„å»¶æ—¶æ—¶é—´åŽï¼Œå°†fnå›žè°ƒæŽ¨å…¥ å®ä»»åŠ¡é˜Ÿåˆ— æ‰§è¡Œï¼Œä¸ä¿è¯ç²¾å‡†æ—¶é—´

setTimeout(fn, 0) â‰  ç«‹å³æ‰§è¡Œï¼Œå®ƒåªæ˜¯ã€Œå°½å¿«åœ¨å®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œã€ï¼Œä»è¦ç­‰åŒæ­¥ä»£ç  + å¾®ä»»åŠ¡æ‰§è¡Œå®Œã€‚

### setInterval

æ¯éš” delay æ¯«ç§’ï¼Œå°†fnå›žè°ƒæŽ¨å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆé‡å¤æ‰§è¡Œï¼Œç›´åˆ° clearInterval åœæ­¢ï¼‰ã€‚

### å…±åŒç‚¹

- æ˜¯ å®ä»»åŠ¡ï¼ˆMacroTaskï¼‰ã€‚
- éƒ½ç”± å®¿ä¸»çŽ¯å¢ƒï¼ˆæµè§ˆå™¨ / Node.jsï¼‰ æä¾›ï¼ŒJS å¼•æ“Žæœ¬èº«æ²¡æœ‰å®šæ—¶å™¨ã€‚
- éƒ½ä¸ä¼šé˜»å¡žä¸»çº¿ç¨‹ï¼ŒçœŸæ­£æ‰§è¡Œå–å†³äºŽ äº‹ä»¶å¾ªçŽ¯ï¼Œæ‰€ä»¥å¹¶ä¸ä¿è¯ã€Œå‡†æ—¶ã€ã€‚

### å¸¸è§å‘ç‚¹

1. æœ€å°å»¶æ—¶è‡³å°‘ 4ms
2. setInterval å¯èƒ½å †ç§¯ï¼š
    å¦‚æžœå›žè°ƒæ‰§è¡Œæ—¶é—´ > é—´éš”ï¼Œä»»åŠ¡ä¼šæŽ’é˜Ÿï¼Œé€ æˆ ä»»åŠ¡å †ç§¯ã€‚
    æ›´æŽ¨èç”¨ é€’å½’ setTimeout æ¨¡æ‹Ÿ setIntervalï¼Œä¿è¯é—´éš”å¯æŽ§ï¼š

    ```js

    function myInterval(fn, delay) {
      function loop() {
        setTimeout(() => {
          fn();
          loop();
        }, delay);
      }
      loop();
    }

    myInterval(() => console.log("tick"), 1000);
    ```

3. ä¸¢å¸§é—®é¢˜

- ç”¨ setInterval(fn, 16) è¯•å›¾å®žçŽ°åŠ¨ç”»æ—¶ï¼Œå¯èƒ½æŽ‰å¸§ï¼Œå› ä¸º JS å›žè°ƒå’Œæ¸²æŸ“ä¸åœ¨åŒä¸€èŠ‚å¥ã€‚

- æ›´å¥½çš„åšæ³•æ˜¯ç”¨ requestAnimationFrame æ¥åšåŠ¨ç”»ã€‚

## æ€»ç»“

setTimeout(fn, 0) â†’ ä¸ç­‰äºŽç«‹å³æ‰§è¡Œï¼Œå®žé™…æ˜¯ã€ŒåŒæ­¥ä»£ç  + å¾®ä»»åŠ¡æ‰§è¡Œå®ŒåŽï¼Œæ‰è¿›é˜Ÿåˆ—ã€ã€‚

setInterval ä¸é è°±ï¼ˆå¯èƒ½å †ç§¯ï¼‰ï¼Œé€’å½’ setTimeout æ›´ç²¾å‡†ã€‚

åšåŠ¨ç”»ä¼˜å…ˆ requestAnimationFrameï¼Œåšå»¶æ—¶ä»»åŠ¡æ‰ç”¨å®šæ—¶å™¨ã€‚

### requestAnimationFrame

ç®€ç§° rAF æ˜¯å‰ç«¯æ€§èƒ½ä¼˜åŒ–é‡Œéžå¸¸å…³é”®çš„ APIï¼Œä¸»è¦ç”¨äºŽåŠ¨ç”»æ¸²æŸ“ã€‚

1. åŸºæœ¬æ¦‚å¿µ

   - å‘Šè¯‰æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰ï¼Œæ‰§è¡Œå›žè°ƒ
   - å›žè°ƒå‡½æ•°çš„æ‰§è¡Œé¢‘çŽ‡â‰ˆæµè§ˆå™¨åˆ·æ–°çŽ‡ï¼Œå¤§å¤šæ•°å±å¹•æ˜¯ 60Hz â†’ æ¯ 16.6ms æ‰§è¡Œä¸€æ¬¡ï¼‰ã€‚ä¸ä¼šã€Œä¸¢å¸§ã€æˆ–ã€Œå¤šä½™ç»˜åˆ¶ã€

2. ç”¨æ³•

    ```js
    function animate() {
      // åœ¨è¿™é‡Œæ›´æ–°å…ƒç´ ä½ç½®ã€é€æ˜Žåº¦ã€ç¼©æ”¾ç­‰
      box.style.left = (parseInt(box.style.left) || 0) + 2 + "px";

      // é€’å½’è°ƒç”¨
      requestAnimationFrame(animate);
    }

    // å¯åŠ¨åŠ¨ç”»
    requestAnimationFrame(animate);
    ```

3. å–æ¶ˆåŠ¨ç”»

    å’Œå®šæ—¶å™¨ç±»ä¼¼ï¼ŒrequestAnimationFrame ä¹Ÿæœ‰ IDï¼Œå¯ä»¥ç”¨ cancelAnimationFrame åœæ­¢ã€‚

    ```js
    let id;

    function move() {
      box.style.left = (parseInt(box.style.left) || 0) + 2 + "px";
      id = requestAnimationFrame(move);
    }

    id = requestAnimationFrame(move);

    // åœæ­¢åŠ¨ç”»
    setTimeout(() => {
      cancelAnimationFrame(id);
    }, 2000);
    ```
