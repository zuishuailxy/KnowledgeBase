# è·¨æ ‡ç­¾é¡µé€šä¿¡

## BroadCast Channel

åŒæºæ‰€æœ‰æ ‡ç­¾é¡µå¯ä»¥é€šä¿¡
å®æ—¶æ€§ é«˜
æ•°æ®å¤§å° æ— é™åˆ¶
éœ€è¦æ‰‹åŠ¨æ¸…é™¤

```html
<!DOCTYPE html>
<html>
  <head>
    <title>BroadcastChannel æµ‹è¯• Demo</title>
  </head>
  <body>
    <h2>è·¨æ ‡ç­¾é¡µé€šä¿¡æµ‹è¯•</h2>
    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯" />
    <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
    <div id="messageContainer" style="margin-top: 20px;"></div>

    <script>
      // 1. åˆ›å»º Broadcast Channel å®ä¾‹ï¼ˆé¢‘é“åéœ€ä¸€è‡´ï¼‰[1,3](@ref)
      const channel = new BroadcastChannel("test_demo_channel");
      const messageInput = document.getElementById("messageInput");
      const messageContainer = document.getElementById("messageContainer");

      // 2. å‘é€æ¶ˆæ¯å‡½æ•°[3,8](@ref)
      function sendMessage() {
        const text = messageInput.value.trim();
        if (text) {
          // å‘é€ç»“æ„åŒ–æ¶ˆæ¯ï¼ˆå«æ—¶é—´æˆ³ï¼‰[5,8](@ref)
          channel.postMessage({
            type: "TEXT_MESSAGE",
            content: text,
            timestamp: new Date().toLocaleTimeString(),
          });
          messageInput.value = "";
        }
      }

      // 3. æ¥æ”¶æ¶ˆæ¯ç›‘å¬å™¨[3,4](@ref)
      channel.onmessage = (event) => {
        const { type, content, timestamp } = event.data;
        if (type === "TEXT_MESSAGE") {
          const messageDiv = document.createElement("div");
          messageDiv.textContent = `[${timestamp}] æ”¶åˆ°æ¶ˆæ¯: ${content}`;
          messageContainer.appendChild(messageDiv);
        }
      };

      // 4. é¡µé¢å…³é—­æ—¶é‡Šæ”¾èµ„æº[1,8](@ref)
      window.addEventListener("beforeunload", () => {
        channel.close();
      });
    </script>
  </body>
</html>
```

## Service Worker

```js
// service-worker.js
self.addEventListener("message", (event) => {
  // å‘Šè¯‰æ‰€æœ‰æ ‡ç­¾é¡µ
  self.clients.matchAll().then((clients) => {
    clients.forEach((client) => client.postMessage(event.data));
  });
});

// æ ‡ç­¾é¡µä»£ç 
navigator.serviceWorker.onmessage = (event) => {
  console.log("é‚®å·®é€æ¥æ¶ˆæ¯:", event.data);
};

// å‘é€æ¶ˆæ¯
navigator.serviceWorker.controller.postMessage("å¿«é€’åˆ°å•¦ï¼");
```

## localStorage

åŒæºæ‰€æœ‰æ ‡ç­¾é¡µå¯ä»¥é€šä¿¡
å®æ—¶æ€§ ä½ ä¾èµ–äºæ—¶é—´å¾ªç¯
æ•°æ®å¤§å° 5mb
éœ€è¦æ‰‹åŠ¨æ¸…é™¤

```js
// æ ‡ç­¾1å†™ä¸‹ç•™è¨€
localStorage.setItem("message", "ä»Šæ™šåƒç«é”…ï¼");

// æ ‡ç­¾2ç›‘å¬å°æœ¬æœ¬å˜åŒ–
window.addEventListener("storage", (event) => {
  if (event.key === "message") {
    console.log("æ–°ç•™è¨€:", event.newValue);
  }
});
```

## SharedWorker

åŒæºå¤šæ ‡ç­¾é¡µã€iframeã€çª—å£å¯ä»¥é€šä¿¡
å¯ç»´æŠ¤å…±äº«çŠ¶æ€å’Œå˜é‡
ç‹¬ç«‹äºé¡µé¢ï¼Œå¯é•¿æœŸè¿è¡Œ
å¤æ‚çŠ¶æ€åŒæ­¥ã€åå°ä»»åŠ¡

```js
// ä¸»çº¿ç¨‹ï¼ˆé¡µé¢ï¼‰
const worker = new SharedWorker('worker.js', { name: 'myWorker' });
worker.port.start(); // å¯åŠ¨é€šä¿¡ç«¯å£

// å‘é€æ¶ˆæ¯
worker.port.postMessage({ type: 'update', data: 123 });

// æ¥æ”¶æ¶ˆæ¯
worker.port.onmessage = (e) => {
  console.log('æ”¶åˆ°æ¶ˆæ¯:', e.data);
};

<!-- worker.js -->
let clients = [];
self.onconnect = (e) => {
  const port = e.ports[0];
  clients.push(port);

  // æ¥æ”¶æ¶ˆæ¯å¹¶å¹¿æ’­
  port.onmessage = (e) => {
    clients.forEach(client => client.postMessage(e.data));
  };
};
```

## è½®è¯¢ (IndexedDB/Cookie)

```js
// æ–¹æ¡ˆ5ï¼šIndexedDBè½®è¯¢
setInterval(() => {
  db.get("message").then((val) => {
    if (val !== lastMessage) {
      console.log("å‘ç°æ–°æ¶ˆæ¯:", val);
      lastMessage = val;
    }
  });
}, 1000);

// æ–¹æ¡ˆ6ï¼šCookieè½®è¯¢
setInterval(() => {
  const msg = getCookie("message");
  if (msg !== lastMsg) {
    console.log("Cookieæ¶ˆæ¯:", msg);
    lastMsg = msg;
  }
}, 1000);
```

## åˆ©ç”¨ window.open()

```js
// çˆ¶çª—å£
const child = window.open("child.html");
child.postMessage("ä¹–å„¿å­", "https://same-origin.com");

// å­çª—å£
window.opener.postMessage("è€çˆ¸å¥½ï¼", "https://same-origin.com");

// ä¸¤è¾¹éƒ½è¦ç›‘å¬
window.addEventListener("message", (event) => {
  if (event.origin !== "https://same-origin.com") return;
  console.log("æ”¶åˆ°:", event.data);
});
```

## WebSocket

åŒå‘å…¨åŒå·¥
ä¸€æ¬¡æ¡æ‰‹ï¼ŒæŒä¹…è¿æ¥
å®æ—¶äº¤äº’ï¼ˆèŠå¤©ã€æ¸¸æˆï¼‰

```js
const socket = new WebSocket("wss://example.com/chat");

// è¿æ¥å»ºç«‹
socket.onopen = () => {
  socket.send("Hello Server!");
};

// æ¥æ”¶æ¶ˆæ¯
socket.onmessage = (event) => {
  console.log("æ”¶åˆ°æ¶ˆæ¯:", event.data);
};

// é”™è¯¯å¤„ç†
socket.onerror = (error) => {
  console.error("è¿æ¥é”™è¯¯:", error);
};
```

## SharedArrayBuffer

ç”¨äºåœ¨å¤šä¸ª â€‹â€‹Web Workerâ€‹â€‹ æˆ– â€‹â€‹ ä¸»çº¿ç¨‹ â€‹â€‹ ä¹‹é—´å…±äº«å†…å­˜çš„åº•å±‚ API

å…³é”®ç‰¹æ€§ï¼š
â€‹â€‹ å…±äº«å†…å­˜ â€‹â€‹ï¼šå¤šä¸ªçº¿ç¨‹å…±äº«åŒä¸€å—äºŒè¿›åˆ¶ç¼“å†²åŒºï¼ˆArrayBufferï¼‰ã€‚
â€‹â€‹ åŸå­æ“ä½œ â€‹â€‹ï¼šé€šè¿‡ Atomics å¯¹è±¡å®ç°çº¿ç¨‹å®‰å…¨çš„è¯»å†™æ“ä½œï¼Œé¿å…ç«æ€æ¡ä»¶ã€‚
â€‹â€‹ é«˜æ€§èƒ½ â€‹â€‹ï¼šé€‚ç”¨äºéœ€è¦å¤„ç†å¤§è§„æ¨¡æ•°æ®çš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼ˆå¦‚éŸ³è§†é¢‘å¤„ç†ã€ç‰©ç†æ¨¡æ‹Ÿï¼‰ã€‚

```js
// ä¸»çº¿ç¨‹ä¸­åˆ›å»º 1024 å­—èŠ‚çš„å…±äº«å†…å­˜
const sharedBuffer = new SharedArrayBuffer(1024);

//2. ä¼ é€’åˆ° Web Worker
const worker = new Worker("worker.js");
worker.postMessage(sharedBuffer); // ä¼ é€’ SAB çš„å¼•ç”¨

// 3. Worker ä¸­æ¥æ”¶å¹¶ä½¿ç”¨
self.onmessage = (e) => {
  const sharedBuffer = e.data;
  const intArray = new Int32Array(sharedBuffer);

  // ä½¿ç”¨ Atomics å®‰å…¨å†™å…¥æ•°æ®
  Atomics.store(intArray, 0, 42); // åœ¨ç´¢å¼• 0 å¤„å†™å…¥ 42
};

//4. ä¸»çº¿ç¨‹åŒæ­¥è¯»å–
const intArray = new Int32Array(sharedBuffer);
Atomics.load(intArray, 0); // è¿”å› 42ï¼ˆçº¿ç¨‹å®‰å…¨è¯»å–ï¼‰
```

reference: <a href="https://juejin.cn/post/7490769323969167394">é¢è¯•ä¸€é—®å°±ç»™æˆ‘æ•´ä¸ä¼šäº†ğŸ˜­å¦‚ä½•è·¨æ ‡ç­¾é¡µé€šä¿¡</a>
